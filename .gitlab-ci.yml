stages:
    - ghidra
    - plugin-builder


.build:
    image: docker
    tags:
        - docker
    services:
        - name: docker:dind
          alias: docker
    variables:
        DOCKER_HOST: 'tcp://docker:2375'
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || true
        - docker pull ${TAG} || true
    after_script:
        - docker push ${TAG}

.base:
    stage: ghidra
    extends: .build
    variables:
        TAG: ${CI_REGISTRY_IMAGE}/ghidra:${GHIDRA_VERSION}
        DIRECTORY: 'base'
    script:
        - docker build --cache-from ${TAG} --build-arg GHIDRA_URL=${GHIDRA_URL} -t ${TAG} ${DIRECTORY}

.plugin-builder:
    stage: plugin-builder
    extends: .build
    variables:
        TAG: ${CI_REGISTRY_IMAGE}/ghidra-plugin-builder:${GHIDRA_VERSION}
        DIRECTORY: plugin-builder
    script:
        - docker build --cache-from ${TAG} --build-arg GHIDRA_VERSION=${GHIDRA_VERSION} --build-arg CI_REGISTRY_IMAGE=${CI_REGISTRY_IMAGE} -t ${TAG} ${DIRECTORY}
        

ghidra 9.1.2:
    extends: .base
    variables:
        GHIDRA_VERSION: '9.1.2'
        GHIDRA_URL: https://ghidra-sre.org/ghidra_9.1.2_PUBLIC_20200212.zip

ghira 9.1.1:
    extends: .base
    variables:
        GHIDRA_VERSION: '9.1.1'
        GHIDRA_URL: https://ghidra-sre.org/ghidra_9.1.1_PUBLIC_20191218.zip


plugin-builder 9.1.2:
    extends: .plugin-builder
    variables:
        GHIDRA_VERSION: '9.1.2'

plugin-builder 9.1.1:
    extends: .plugin-builder
    variables:
        GHIDRA_VERSION: '9.1.1'
